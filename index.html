<!DOCTYPE html>
<html lang="zh-CN" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥è¯­å­¦ä¹ æ—¥è®° | æ¯æ—¥è®°å½•</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* (æ‰€æœ‰æ ·å¼...ä¸ä¹‹å‰ç›¸åŒ) */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        body { font-family: 'Inter', 'Noto Sans JP', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif; background: linear-gradient(120deg, #1e0033, #3f004a, #1a0b38); background-size: 200% 200%; animation: gradientBG 20s ease infinite; overflow: hidden; }
        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50 { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .glass-card { background: rgba(255, 255, 255, 0.05); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); }
        .glass-card:hover { transform: translateY(-6px); box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2); border-color: rgba(255, 255, 255, 0.2); }
        .tab-button.active { color: white; background-color: #8B5CF6; }
        .form-input { background: rgba(0, 0, 0, 0.2); border: 1px solid rgba(255, 255, 255, 0.1); transition: all 0.3s ease; }
        .form-input:focus { background: rgba(0, 0, 0, 0.3); border-color: #8B5CF6; box-shadow: 0 0 0 2px #8B5CF6; }
        .btn-gradient { background-image: linear-gradient(to right, #8B5CF6 0%, #EC4899 51%, #8B5CF6 100%); background-size: 200% auto; transition: 0.5s; }
        .btn-gradient:hover { background-position: right center; }
        .btn-gradient:disabled { opacity: 0.5; cursor: not-allowed; background-image: none; background-color: #374151; }
        .btn-gradient-delete { background-image: linear-gradient(to right, #EF4444 0%, #EC4899 51%, #EF4444 100%); background-size: 200% auto; transition: 0.5s; }
        .btn-gradient-delete:hover { background-position: right center; }
        .btn-gradient-delete:disabled { opacity: 0.5; cursor: not-allowed; background-image: none; background-color: #374151; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .summary-card { animation: fadeIn 0.5s ease-out forwards; }
        .loader { width: 48px; height: 48px; border: 3px solid #FFF; border-bottom-color: #8B5CF6; border-radius: 50%; display: inline-block; box-sizing: border-box; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadeInOverlay { from { opacity: 0; } to { opacity: 1; } }
        @keyframes floatIn { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        
        /* ã€æ–°å¢ã€‘è¯¦æƒ…æ¨¡æ€æ¡†å†…çš„æ»šåŠ¨æ¡æ ·å¼ (é€‚é…æš—è‰²æ¨¡å¼) */
        .modal-content-scroll {
            scrollbar-width: thin;
            scrollbar-color: #5b21b6 #1f2937;
        }
        .modal-content-scroll::-webkit-scrollbar {
            width: 8px;
        }
        .modal-content-scroll::-webkit-scrollbar-track {
            background: #1f2937;
            border-radius: 10px;
        }
        .modal-content-scroll::-webkit-scrollbar-thumb {
            background-color: #5b21b6;
            border-radius: 10px;
            border: 2px solid #1f2937;
        }
    </style>
</head>
<!-- ã€ä¿®æ”¹ã€‘å¢åŠ äº† body çš„ paddingï¼Œè®© UI ä¸ä¼šå¤ªé ä¸Š -->
<body class="text-gray-100 min-h-screen p-6 md:p-12">

    <!-- (ç™»å½•è’™ç‰ˆ...HTMLä¸ä¹‹å‰ç›¸åŒ) -->
    <div id="login-mask" class="fixed inset-0 z-50 flex items-center justify-center p-4" style="animation: fadeInOverlay 0.5s ease-out forwards;">
        <div class="absolute inset-0 bg-black/70 backdrop-blur-sm"></div>
        <div class="glass-card rounded-xl shadow-lg max-w-sm w-full z-10 p-6 md:p-10" style="animation: floatIn 0.6s ease-out 0.2s forwards; opacity: 0;">
            <div class="flex justify-center mb-6">
                <div id="avatar-loader" class="rounded-full w-32 h-32 border-4 border-purple-400/50 shadow-lg flex items-center justify-center bg-purple-900/50">
                    <div class="loader" style="width: 40px; height: 40px; border-bottom-color: #FFF;"></div>
                </div>
                <img id="avatar-image" alt="å¤´åƒ" class="rounded-full w-32 h-32 border-4 border-purple-400/50 shadow-lg hidden object-cover"
                     onerror="this.src='https://placehold.co/120x120/331a4a/a975ff?text=Avatar'; this.classList.remove('hidden'); document.getElementById('avatar-loader').classList.add('hidden');">
            </div>
            <h2 class="text-2xl font-semibold text-center text-gray-100 mb-6">ç®¡ç†å‘˜ç™»å½•</h2>
            <div class="mb-5">
                <label for="login-password" class="block text-sm font-medium text-gray-300 mb-2">ğŸ”‘ ç®¡ç†å‘˜å¯†ç </label>
                <input type="password" id="login-password" class="form-input w-full rounded-lg p-3 text-gray-100" placeholder="è¯·è¾“å…¥å¯†ç " required>
            </div>
            <div id="login-message" class="mt-4 text-center text-red-400 h-6"></div>
            <button id="login-button" class="btn-gradient w-full text-white font-bold py-3 px-6 rounded-lg text-lg mt-6">
                <span>è¿›å…¥æ—¥è®°</span>
            </button>
        </div>
    </div>

    <!-- (ä¸»å†…å®¹åŒºåŸŸ...HTMLä¸ä¹‹å‰ç›¸åŒ) -->
    <div id="main-content" class="hidden">
        <header class="text-center mb-10">
            <h1 class="text-4xl md:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-500">
                ğŸŒ¸ æˆ‘çš„æ—¥è¯­å­¦ä¹ æ—¥è®° ğŸŒ¸
            </h1>
            <p class="text-lg text-gray-300 mt-2">æ—¥ã€…ã®è¨˜éŒ²ã€æœªæ¥ã¸ã®æŠ•è³‡ã€‚</p>
        </header>
        <main class="max-w-4xl mx-auto">
            <div class="flex justify-center mb-8 bg-gray-800/50 rounded-lg p-1 max-w-sm mx-auto">
                <button id="tab-view" class="tab-button active w-1/2 py-2 px-4 rounded-md font-medium transition-all duration-300">æŸ¥çœ‹æ€»ç»“</button>
                <button id="tab-submit" class="tab-button w-1/2 py-2 px-4 rounded-md font-medium text-gray-400 transition-all duration-300">æäº¤æ–°æ€»ç»“</button>
            </div>
            <div>
                <section id="section-view">
                    <div id="delete-message" class="text-center mb-4"></div>
                    <div id="loading-spinner" class="text-center py-10">
                        <div class="loader mx-auto"></div><p class="mt-4 text-gray-400">æ­£åœ¨åŠ è½½æ—¥è®°...</p>
                    </div>
                    <div id="summary-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
                    <p id="no-summaries" class="hidden text-center text-gray-400 py-10">è¿˜æ²¡æœ‰æ—¥è®°å“¦ï¼Œå¿«å»â€œæäº¤æ–°æ€»ç»“â€å§ï¼</p>
                </section>
                <section id="section-submit" class="hidden">
                    <div class="glass-card rounded-xl p-6 md:p-10 shadow-lg max-w-lg mx-auto">
                        <form id="summary-form">
                            <h2 class="text-2xl font-semibold text-center mb-6">ğŸ“ è®°å½•ä»Šæ—¥æ‰€å­¦</h2>
                            <div class="mb-6">
                                <label for="summary-content" class="block text-sm font-medium text-gray-300 mb-2">ğŸ“– å­¦ä¹ å†…å®¹</label>
                                <textarea id="summary-content" rows="6" class="form-input w-full rounded-lg p-3 text-gray-100" placeholder="ä¾‹å¦‚ï¼šä»Šå¤©å­¦ä¹ äº†... æŒæ¡äº†... é‡åˆ°çš„é—®é¢˜æ˜¯..." required></textarea>
                            </div>
                            <button type="submit" id="submit-button" class="btn-gradient w-full text-white font-bold py-3 px-6 rounded-lg text-lg">
                                <span>æäº¤æ€»ç»“</span>
                            </button>
                            <div id="form-message" class="mt-4 text-center"></div>
                        </form>
                    </div>
                </section>
            </div>
        </main>
        <footer class="text-center text-gray-500 mt-16 pb-8">
            <p>&copy; 2025 ç”± Gemini å¼ºåŠ›é©±åŠ¨</p>
        </footer>
    </div>

    <!-- (åˆ é™¤ç¡®è®¤æ¨¡æ€æ¡†...HTMLä¸ä¹‹å‰ç›¸åŒ) -->
    <div id="confirm-delete-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div id="confirm-modal-overlay" class="absolute inset-0 bg-black/70 backdrop-blur-sm"></div>
        <div class="glass-card rounded-xl p-6 md:p-8 shadow-lg max-w-sm w-full z-10" style="animation: fadeIn 0.3s ease-out forwards;">
            <h3 class="text-2xl font-semibold text-center mb-5">ğŸ—‘ï¸ ç¡®è®¤åˆ é™¤</h3>
            <p class="text-gray-300 text-center mb-8">æ‚¨ç¡®å®šè¦åˆ é™¤è¿™æ¡æ—¥è®°å—ï¼Ÿ<br>æ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚</p>
            <div id="confirm-modal-message" class="mt-4 text-center text-red-400 h-6"></div>
            <div class="flex gap-4 mt-6">
                <button id="confirm-delete-cancel-btn" class="w-1/2 py-3 px-4 rounded-lg font-medium text-gray-300 bg-gray-700/60 hover:bg-gray-600/60 transition-colors">
                    å–æ¶ˆ
                </button>
                <button id="confirm-delete-confirm-btn" class="btn-gradient-delete w-1/2 text-white font-bold py-3 px-4 rounded-lg text-lg">
                    <span>ç¡®è®¤åˆ é™¤</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- ã€æ–°å¢ã€‘æ—¥è®°è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="details-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div id="details-modal-overlay" class="absolute inset-0 bg-black/70 backdrop-blur-sm"></div>
        
        <div class="glass-card rounded-xl shadow-lg max-w-lg w-full z-10" 
             style="animation: floatIn 0.5s ease-out forwards; max-height: 80vh; display: flex; flex-direction: column;">
            
            <!-- æ¨¡æ€æ¡†å¤´éƒ¨ -->
            <div class="p-6 border-b border-white/10">
                <h3 class="text-2xl font-semibold text-center text-transparent bg-clip-text bg-gradient-to-r from-purple-400 to-pink-500">
                    ğŸ“– æ—¥è®°è¯¦æƒ…
                </h3>
            </div>
            
            <!-- æ¨¡æ€æ¡†å†…å®¹ (å¯æ»šåŠ¨) -->
            <div class="p-6 md:p-8 flex-1 overflow-y-auto modal-content-scroll">
                <p id="details-date" class="text-sm text-gray-400 mb-4"></p>
                <p id="details-summary" class="text-gray-100 whitespace-pre-line text-base leading-relaxed"></p>
                
                <div id="details-gemini-container" class="mt-6 hidden">
                     <p class="mt-4 text-sm text-purple-300 border-l-2 border-purple-400 pl-3">
                        ğŸ¤– è€å¸ˆç‚¹è¯„ï¼š<span id="details-gemini"></span>
                     </p>
                </div>
            </div>
            
            <!-- æ¨¡æ€æ¡†å°¾éƒ¨ -->
            <div class="p-4 bg-white/5 border-t border-white/10 text-right">
                <button id="details-close-btn" class="py-2 px-5 rounded-lg font-medium text-gray-300 bg-gray-700/60 hover:bg-gray-600/60 transition-colors">
                    å…³é—­
                </button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- å…¨å±€å˜é‡ ---
            let sessionPassword = null;
            let summaryCache = {}; // ã€æ–°å¢ã€‘ç”¨äºå­˜å‚¨æ—¥è®°æ•°æ®ï¼Œæ–¹ä¾¿è¯¦æƒ…é¡µè°ƒç”¨
            let entryIdToDelete = null;
            let cardElementToDelete = null;

            // --- è·å–å…ƒç´  ---
            const mainContent = document.getElementById('main-content');
            const loginMask = document.getElementById('login-mask');
            const loginPasswordInput = document.getElementById('login-password');
            const loginButton = document.getElementById('login-button');
            const loginMessage = document.getElementById('login-message');
            const avatarLoader = document.getElementById('avatar-loader');
            const avatarImage = document.getElementById('avatar-image');
            const tabView = document.getElementById('tab-view');
            const tabSubmit = document.getElementById('tab-submit');
            const sectionView = document.getElementById('section-view');
            const sectionSubmit = document.getElementById('section-submit');
            const summaryForm = document.getElementById('summary-form');
            const submitButton = document.getElementById('submit-button');
            const formMessage = document.getElementById('form-message');
            const contentInput = document.getElementById('summary-content');
            const summaryGrid = document.getElementById('summary-grid');
            const loadingSpinner = document.getElementById('loading-spinner');
            const noSummaries = document.getElementById('no-summaries');
            const deleteMessage = document.getElementById('delete-message');
            
            // åˆ é™¤æ¨¡æ€æ¡†
            const confirmDeleteModal = document.getElementById('confirm-delete-modal');
            const confirmModalOverlay = document.getElementById('confirm-modal-overlay');
            const confirmDeleteCancelBtn = document.getElementById('confirm-delete-cancel-btn');
            const confirmDeleteConfirmBtn = document.getElementById('confirm-delete-confirm-btn');
            const confirmModalMessage = document.getElementById('confirm-modal-message');

            // ã€æ–°å¢ã€‘è¯¦æƒ…æ¨¡æ€æ¡†
            const detailsModal = document.getElementById('details-modal');
            const detailsModalOverlay = document.getElementById('details-modal-overlay');
            const detailsCloseBtn = document.getElementById('details-close-btn');
            const detailsDate = document.getElementById('details-date');
            const detailsSummary = document.getElementById('details-summary');
            const detailsGeminiContainer = document.getElementById('details-gemini-container');
            const detailsGemini = document.getElementById('details-gemini');

            const trashIconSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4H2.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg>`;

            // (åŠ è½½å¤´åƒé€»è¾‘...ä¸ä¹‹å‰ç›¸åŒ)
            async function loadAvatar() { /* ... (æ­¤å¤„çœç•¥ä»£ç ä»¥ä¿æŒç®€æ´) ... */ }
            async function loadAvatar(){try{avatarLoader.classList.remove('hidden');avatarImage.classList.add('hidden');let imageData;if(window.location.protocol.startsWith('blob')||window.location.protocol==='file:'){console.log("æœ¬åœ°é¢„è§ˆæ¨¡å¼ï¼šæ¨¡æ‹ŸåŠ è½½å¤´åƒ...");await new Promise(resolve=>setTimeout(resolve,1500));imageData="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='%238B5CF6'/%3E%3Ctext x='50' y='60' font-size='30' fill='white' text-anchor='middle'%3E( Ë˜vË˜ )%3C/text%3E%3C/svg%3E";}else{const response=await fetch('/api/getAvatar');if(!response.ok){const err=await response.json();throw new Error(err.error||'è·å–å¤´åƒå¤±è´¥');}
            const result=await response.json();imageData=result.imageData;if(!imageData){throw new Error('æœªä»æœåŠ¡å™¨è·å–åˆ°å›¾åƒæ•°æ®');}}
            avatarImage.src=imageData;avatarImage.classList.remove('hidden');avatarLoader.classList.add('hidden');}catch(error){console.error('åŠ è½½å¤´åƒå¤±è´¥:',error);avatarImage.src='https://placehold.co/120x120/331a4a/a975ff?text=Avatar';avatarImage.classList.remove('hidden');avatarLoader.classList.add('hidden');loginMessage.textContent=`âŒ å¤´åƒåŠ è½½å¤±è´¥: ${error.message}`;}}

            // (ç™»å½•é€»è¾‘...ä¸ä¹‹å‰ç›¸åŒ)
            async function handleLogin() { /* ... (æ­¤å¤„çœç•¥ä»£ç ä»¥ä¿æŒç®€æ´) ... */ }
            async function handleLogin(){const password=loginPasswordInput.value;if(!password){loginMessage.textContent='è¯·è¾“å…¥å¯†ç ';return;}
            loginButton.disabled=true;loginButton.innerHTML=`<span class="loader" style="width:24px; height:24px; border-width: 2px;"></span>`;if(!loginMessage.textContent.includes('å¤´åƒåŠ è½½å¤±è´¥')){loginMessage.textContent='';}
            try{if(window.location.protocol.startsWith('blob')||window.location.protocol==='file:'){console.log("æœ¬åœ°é¢„è§ˆæ¨¡å¼ï¼šæ¨¡æ‹Ÿç™»å½•...");await new Promise(resolve=>setTimeout(resolve,1000));}else{const response=await fetch('/api/checkPassword',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({password})});const result=await response.json();if(!response.ok){throw new Error(result.error||'ç™»å½•å¤±è´¥');}}
            sessionPassword=password;loginMask.style.transition='opacity 0.5s ease-out';loginMask.style.opacity='0';setTimeout(()=>loginMask.classList.add('hidden'),500);mainContent.classList.remove('hidden');mainContent.style.animation='fadeInOverlay 0.5s ease-out';document.body.style.overflow='auto';loadSummaries();}catch(error){console.error('ç™»å½•å¤±è´¥:',error);loginMessage.textContent=`âŒ å¤±è´¥: ${error.message}`;loginButton.disabled=false;loginButton.innerHTML='<span>è¿›å…¥æ—¥è®°</span>';}}
            loginButton.addEventListener('click',handleLogin);loginPasswordInput.addEventListener('keydown',(e)=>{if(e.key==='Enter'){handleLogin();}});

            // (æ ‡ç­¾é¡µåˆ‡æ¢...ä¸ä¹‹å‰ç›¸åŒ)
            function showViewSection(){sectionView.classList.remove('hidden');sectionSubmit.classList.add('hidden');tabView.classList.add('active','text-white');tabSubmit.classList.remove('active','text-white');tabSubmit.classList.add('text-gray-400');loadSummaries();}
            function showSubmitSection(){sectionView.classList.add('hidden');sectionSubmit.classList.remove('hidden');tabView.classList.remove('active','text-white');tabView.classList.add('text-gray-400');tabSubmit.classList.add('active','text-white');}
            tabView.addEventListener('click',showViewSection);tabSubmit.addEventListener('click',showSubmitSection);

            // --- åŠ è½½æ€»ç»“é€»è¾‘ ---
            async function loadSummaries(){
                loadingSpinner.classList.remove('hidden');
                summaryGrid.innerHTML='';
                noSummaries.classList.add('hidden');
                deleteMessage.textContent='';
                summaryCache = {}; // ã€ä¿®æ”¹ã€‘æ¸…ç©ºç¼“å­˜
                
                // ... (æ¨¡æ‹Ÿæ•°æ®é€»è¾‘...ä¸ä¹‹å‰ç›¸åŒ) ...
                if(window.location.protocol.startsWith('blob')||window.location.protocol==='file:'){
                    console.log("æœ¬åœ°é¢„è§ˆæ¨¡å¼ï¼šæ­£åœ¨åŠ è½½æ¨¡æ‹Ÿæ•°æ®...");
                    await new Promise(resolve=>setTimeout(resolve,1000));
                    const mockSummaries=[ { date: new Date().toISOString(), summary: "ã€æ¨¡æ‹Ÿæ•°æ®ã€‘ä»Šå¤©å­¦ä¹ äº† N2 è¯­æ³•ã€Œï½ã‚‚ã®ã ã‹ã‚‰ã€ï¼Œæ„Ÿè§‰å¾ˆæœ‰è¶£ã€‚\nç¬¬äºŒè¡Œæµ‹è¯•ã€‚\nç¬¬ä¸‰è¡Œæµ‹è¯•ã€‚", gemini_response: "ç´ æ™´ã‚‰ã—ã„ï¼ãã®èª¿å­ã§é ‘å¼µã£ã¦ï¼" }, { date: new Date(Date.now() - 86400000).toISOString(), summary: "ã€æ¨¡æ‹Ÿæ•°æ®ã€‘å¤ä¹ äº† N3 çš„åŠ¨è¯å˜å½¢ã€‚", gemini_response: null } ];
                    if(mockSummaries.length===0){ noSummaries.classList.remove('hidden'); }
                    else { mockSummaries.forEach(item=>{ createCard(item); }); }
                    loadingSpinner.classList.add('hidden');
                    return;
                }
            
                try{
                    const response = await fetch('/api/getSummaries');
                    if(!response.ok){
                        const err = await response.json();
                        throw new Error(err.error || `HTTP error! status: ${response.status}`);
                    }
                    const summaries = await response.json();
                    if (!Array.isArray(summaries)) {
                        console.error("å‰ç«¯æ”¶åˆ°çš„æ—¥è®°æ•°æ®ä¸æ˜¯ä¸€ä¸ªåˆ—è¡¨ (Array)!");
                        noSummaries.classList.remove('hidden');
                        loadingSpinner.classList.add('hidden');
                        return; 
                    }
                    if(summaries.length === 0){
                        noSummaries.classList.remove('hidden');
                    } else {
                        summaries.sort((a,b) => new Date(b.date) - new Date(a.date));
                        summaries.forEach(item => { createCard(item); });
                    }
                } catch(error) {
                    console.error('åŠ è½½æ€»ç»“å¤±è´¥:', error);
                    noSummaries.textContent = `âŒ åŠ è½½æ—¥è®°å¤±è´¥: ${error.message}`;
                    noSummaries.classList.remove('hidden');
                } finally {
                    loadingSpinner.classList.add('hidden');
                }
            }

            // --- åˆ›å»ºå¡ç‰‡ ---
            function createCard(item){
                summaryCache[item.date] = item; // ã€æ–°å¢ã€‘å°†æ—¥è®°å­˜å…¥ç¼“å­˜
                
                const card=document.createElement('div');
                // ã€ä¿®æ”¹ã€‘å¢åŠ äº† cursor-pointer ä½¿å¡ç‰‡å¯ç‚¹å‡»
                card.className='summary-card glass-card rounded-xl p-6 shadow-lg relative cursor-pointer';
                card.dataset.id = item.date; // ã€æ–°å¢ã€‘å°†IDæ·»åŠ åˆ°å¡ç‰‡ä¸Š
                
                const formattedDate=new Date(item.date).toLocaleString('zh-CN',{year:'numeric',month:'long',day:'numeric',hour:'numeric',minute:'numeric'});
                
                // ã€ä¿®æ”¹ã€‘å¡ç‰‡å†…å®¹ç°åœ¨åªæ˜¾ç¤ºæ‘˜è¦ (æˆªæ–­)
                const summarySnippet = item.summary.split('\n')[0]; // åªå–ç¬¬ä¸€è¡Œ
                
                card.innerHTML=`
                    <button class="delete-btn absolute top-3 right-3 text-gray-500 hover:text-red-400 transition-colors z-10" data-id="${item.date}" title="åˆ é™¤æ­¤æ¡ç›®">
                        ${trashIconSvg}
                    </button>
                    <p class="text-sm text-gray-400 mb-2">${formattedDate}</p>
                    <p class="text-gray-100 whitespace-pre-line truncate">${summarySnippet}</p> <!-- ã€ä¿®æ”¹ã€‘ä½¿ç”¨ truncate æˆªæ–­ -->
                    ${item.gemini_response?`<p class="mt-4 text-sm text-purple-300 border-l-2 border-purple-400 pl-3 truncate">ğŸ¤– è€å¸ˆç‚¹è¯„ï¼š${item.gemini_response}</p>`:''}
                `;
                summaryGrid.appendChild(card);
            }

            // (è¡¨å•æäº¤...ä¸ä¹‹å‰ç›¸åŒ)
            summaryForm.addEventListener('submit',async(e)=>{ /* ... (æ­¤å¤„çœç•¥ä»£ç ä»¥ä¿æŒç®€æ´) ... */ });
            summaryForm.addEventListener('submit',async(e)=>{e.preventDefault();const password=sessionPassword;const summary=contentInput.value;if(!password){formMessage.textContent='âŒ ä¼šè¯æ— æ•ˆï¼Œè¯·åˆ·æ–°é¡µé¢é‡æ–°ç™»å½•ã€‚';formMessage.classList.add('text-red-400');return;}
            submitButton.disabled=true;submitButton.innerHTML=`<span class="loader" style="width:24px; height:24px; border-width: 2px;"></span>`;formMessage.textContent='';formMessage.className='mt-4 text-center';if(window.location.protocol.startsWith('blob')||window.location.protocol==='file:'){console.log("æœ¬åœ°é¢„è§ˆæ¨¡å¼ï¼šæ­£åœ¨æ¨¡æ‹Ÿæäº¤...");await new Promise(resolve=>setTimeout(resolve,1500));formMessage.textContent='ğŸ‰ ã€æ¨¡æ‹Ÿã€‘æäº¤æˆåŠŸï¼';formMessage.classList.add('text-green-400');contentInput.value='';setTimeout(()=>{showViewSection();formMessage.textContent='';},2000);submitButton.disabled=false;submitButton.innerHTML='<span>æäº¤æ€»ç»“</span>';return;}
            try{const response=await fetch('/api/submitSummary',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({password,summary})});const result=await response.json();if(!response.ok){throw new Error(result.error||'æäº¤å¤±è´¥');}
            formMessage.textContent='ğŸ‰ æäº¤æˆåŠŸï¼å·²ç”Ÿæˆ AI ç‚¹è¯„ã€‚';formMessage.classList.add('text-green-400');contentInput.value='';setTimeout(()=>{showViewSection();formMessage.textContent='';},2000);}catch(error){console.error('æäº¤å¤±è´¥:',error);formMessage.textContent=`âŒ å¤±è´¥: ${error.message}`;formMessage.classList.add('text-red-400');}finally{submitButton.disabled=false;submitButton.innerHTML='<span>æäº¤æ€»ç»“</span>';}});

            // --- ã€æ–°å¢ã€‘è¯¦æƒ…æ¨¡æ€æ¡†é€»è¾‘ ---
            function openDetailsModal(item) {
                const formattedDate = new Date(item.date).toLocaleString('zh-CN', { 
                    year: 'numeric', month: 'long', day: 'numeric',
                    hour: 'numeric', minute: 'numeric'
                });
                detailsDate.textContent = formattedDate;
                detailsSummary.textContent = item.summary; // .textContent ä¼šä¿ç•™æ¢è¡Œ
                
                if (item.gemini_response) {
                    detailsGemini.textContent = item.gemini_response;
                    detailsGeminiContainer.classList.remove('hidden');
                } else {
                    detailsGeminiContainer.classList.add('hidden');
                }
                
                detailsModal.classList.remove('hidden');
            }

            function closeDetailsModal() {
                detailsModal.classList.add('hidden');
            }

            detailsModalOverlay.addEventListener('click', closeDetailsModal);
            detailsCloseBtn.addEventListener('click', closeDetailsModal);

            // --- ã€ä¿®æ”¹ã€‘åˆ é™¤æ¨¡æ€æ¡†é€»è¾‘ (æ‰“å¼€) ---
            function openConfirmModal(entryId, cardElement) {
                entryIdToDelete = entryId;
                cardElementToDelete = cardElement;
                confirmDeleteModal.classList.remove('hidden');
            }

            // (å…³é—­)
            function closeConfirmModal() {
                confirmDeleteModal.classList.add('hidden');
                confirmModalMessage.textContent = '';
                entryIdToDelete = null;
                cardElementToDelete = null;
                confirmDeleteConfirmBtn.disabled = false;
                confirmDeleteConfirmBtn.innerHTML = '<span>ç¡®è®¤åˆ é™¤</span>';
            }
            confirmModalOverlay.addEventListener('click', closeConfirmModal);
        	confirmDeleteCancelBtn.addEventListener('click', closeConfirmModal);

            // --- ã€ä¿®æ”¹ã€‘ç»Ÿä¸€çš„äº‹ä»¶ç›‘å¬å™¨ (å¤„ç†è¯¦æƒ…ç‚¹å‡» å’Œ åˆ é™¤ç‚¹å‡») ---
            summaryGrid.addEventListener('click', (e) => {
                const deleteButton = e.target.closest('.delete-btn');
                
                if (deleteButton) {
                    // --- 1. ç‚¹å‡»äº†åˆ é™¤æŒ‰é’® ---
                    e.stopPropagation(); // é˜»æ­¢ç‚¹å‡»äº‹ä»¶å†’æ³¡åˆ°å¡ç‰‡
                    const card = deleteButton.closest('.summary-card');
                    openConfirmModal(deleteButton.dataset.id, card);
                    return;
                }

                const card = e.target.closest('.summary-card');
                if (card && card.dataset.id) {
                    // --- 2. ç‚¹å‡»äº†å¡ç‰‡æœ¬èº« ---
                    const item = summaryCache[card.dataset.id];
                    if (item) {
                        openDetailsModal(item);
                    }
                }
            });

            // --- ã€ä¿®æ”¹ã€‘ç¡®è®¤åˆ é™¤é€»è¾‘ (BUG ä¿®å¤) ---
            confirmDeleteConfirmBtn.addEventListener('click', async () => {
                const password = sessionPassword;
                if (!password) { confirmModalMessage.textContent = 'ä¼šè¯æ— æ•ˆï¼Œè¯·åˆ·æ–°é‡è¯•'; return; }
                if (!entryIdToDelete || !cardElementToDelete) return;

                confirmDeleteConfirmBtn.disabled = true;
                confirmDeleteConfirmBtn.innerHTML = `<span class="loader" style="width:24px; height:24px; border-width: 2px;"></span>`;
                confirmModalMessage.textContent = '';
                
                try {
                    // (æ¨¡æ‹Ÿåˆ é™¤...ä¸ä¹‹å‰ç›¸åŒ)
                    if (window.location.protocol.startsWith('blob') || window.location.protocol === 'file:') {
                        console.log(`æœ¬åœ°é¢„è§ˆï¼šæ¨¡æ‹Ÿåˆ é™¤ ID: ${entryIdToDelete}`);
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    } else {
                        // (çœŸå®åˆ é™¤...ä¸ä¹‹å‰ç›¸åŒ)
                        const response = await fetch('/api/deleteSummary', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ id: entryIdToDelete, password: password })
                        });
                        const result = await response.json();
                        if (!response.ok) { throw new Error(result.error || 'åˆ é™¤å¤±è´¥'); }
                    }
                    
                    // --- ã€BUG ä¿®å¤ã€‘ ---
                    // æˆåŠŸåï¼Œåœ¨ä¸»é¡µæ˜¾ç¤ºæ¶ˆæ¯
                    deleteMessage.textContent = 'âœ… åˆ é™¤æˆåŠŸï¼';
                    deleteMessage.className = 'text-center text-green-400 mb-4';
                    
                    // æ’­æ”¾å¡ç‰‡æ·¡å‡ºåŠ¨ç”»
                    cardElementToDelete.style.transition = 'opacity 0.3s ease-out, transform 0.3s ease-out';
                    cardElementToDelete.style.opacity = '0';
                    cardElementToDelete.style.transform = 'scale(0.95)';
                    
                    // ç­‰å¾…åŠ¨ç”»ç»“æŸåï¼Œå†ç§»é™¤å¡ç‰‡å¹¶å…³é—­æ¨¡æ€æ¡†
                    setTimeout(() => {
                        cardElementToDelete.remove(); // ä» DOM ä¸­ç§»é™¤
                        if (summaryGrid.children.length === 0) {
                            noSummaries.classList.remove('hidden');
                        }
                        closeConfirmModal(); // ã€ä¿®æ”¹ã€‘ç°åœ¨æ‰å…³é—­æ¨¡æ€æ¡†
                    }, 300); // 300ms åŠ¨ç”»æ—¶é—´

                } catch (error) {
                    // å¤±è´¥åï¼Œåœ¨æ¨¡æ€æ¡†å†…æ˜¾ç¤ºé”™è¯¯
                    console.error('åˆ é™¤å¤±è´¥:', error);
                    confirmModalMessage.textContent = `âŒ å¤±è´¥: ${error.message}`;
                    confirmDeleteConfirmBtn.disabled = false;
                    confirmDeleteConfirmBtn.innerHTML = '<span>ç¡®è®¤åˆ é™¤</span>';
                }
                
                // 3ç§’åæ¸…é™¤ä¸»é¡µçš„â€œåˆ é™¤æˆåŠŸâ€æ¶ˆæ¯
                setTimeout(() => {
                    deleteMessage.textContent = '';
                }, 3000);
            });

            // --- åˆå§‹åŠ è½½ ---
            loadAvatar();
            loginPasswordInput.focus();
        });
    </script>
</body>
</html>


