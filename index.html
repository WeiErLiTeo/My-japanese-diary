<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MY DIARY</title>
    <script src="https://cdn.tailwindcss.com"></script>
   Â 
    <!-- Quill.js -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

    <!-- å­—ä½“: Noto Sans JP (ç°ä»£é»‘ä½“) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        /* --- 1. City Boy é£æ ¼é…è‰² & å…¨å±€ --- */
        :root {
            --primary-blue: #0047AB; /* å…‹è±å› è“ */
            --bg-grey: #F2F2F2;      /* æ°´æ³¥ç°èƒŒæ™¯ */
            --paper-white: #FCFCFC;  /* çº¸å¼ ç™½ */
            --text-main: #333333;
            --text-sub: #888888;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: var(--bg-grey);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            perspective: 2000px; /* 3D è§†è· */
        }

        /* --- 2. 3D ä¹¦æœ¬å®¹å™¨ --- */
        .book-wrapper {
            position: relative;
            width: 380px;
            height: 600px;
            transform-style: preserve-3d;
            transition: transform 0.6s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
       Â 
        /* æ¡Œé¢ç«¯æ”¾å¤§ */
        @media (min-width: 768px) {
            .book-wrapper {
                width: 460px;
                height: 680px;
            }
        }

        /* --- 3. å°é¢ (Cover) --- */
        .cover {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: var(--primary-blue);
            border-radius: 4px 12px 12px 4px;
            z-index: 10;
            transform-origin: left center; /* ç»•å·¦è½´æ—‹è½¬ */
            transform-style: preserve-3d;
            transition: transform 1.2s cubic-bezier(0.645, 0.045, 0.355, 1.000);
            cursor: pointer;
            box-shadow: 10px 10px 30px rgba(0,0,0,0.2);
           Â 
            /* å°é¢è®¾è®¡ */
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 40px;
            color: white;
        }

        .cover-title {
            font-size: 3rem;
            font-weight: 900;
            line-height: 1;
            letter-spacing: -1px;
        }
       Â 
        .cover-subtitle {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-top: 10px;
            font-weight: 500;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        .cover-footer {
            font-size: 0.8rem;
            opacity: 0.6;
            border-top: 1px solid rgba(255,255,255,0.3);
            padding-top: 20px;
            display: flex;
            justify-content: space-between;
        }

        /* å°é¢çš„èƒŒé¢ (ç¿»å¼€åçœ‹åˆ°çš„å·¦ä¾§) */
        .cover-back {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-color: #fff;
            border-radius: 4px 12px 12px 4px;
            transform: rotateY(180deg); /* èƒŒé¢ */
            backface-visibility: hidden; /* åªæœ‰ç¿»è¿‡æ¥æ‰çœ‹åˆ° */
            z-index: 9;
            border-right: 1px solid #eee;
        }
        /* æˆ‘ä»¬ç”¨ä¼ªå…ƒç´ æ¨¡æ‹Ÿå°é¢èƒŒé¢çš„è´¨æ„Ÿï¼Œä½†ä¸ºäº†ç®€å•ï¼Œæˆ‘ä»¬åªè®©å®ƒå˜ç™½ */
        .cover::after {
            content: '';
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: #f0f0f0;
            transform: rotateY(180deg) translateZ(1px);
            border-radius: 4px 12px 12px 4px;
            backface-visibility: hidden;
        }


        /* --- 4. å†…é¡µ (Page) --- */
        .page {
            position: absolute;
            top: 2px; left: 0;
            width: 99%; height: 99%; /* ç¨å¾®æ¯”å°é¢å°ä¸€ç‚¹ */
            background-color: var(--paper-white);
            border-radius: 2px 10px 10px 2px;
            z-index: 5;
            box-shadow: inset 3px 0 10px rgba(0,0,0,0.05); /* ä¹¦è„Šé˜´å½± */
           Â 
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
       Â 
        /* --- çŠ¶æ€æ§åˆ¶ --- */
        /* ç¿»å¼€ä¹¦æœ¬ */
        body.book-opened .cover {
            transform: rotateY(-180deg);
        }
        /* ç¿»å¼€åï¼Œä¹¦æœ¬æ•´ä½“ç¨å¾®å³ç§»ï¼Œå±…ä¸­æ˜¾ç¤ºå†…é¡µ */
        body.book-opened .book-wrapper {
            transform: translateX(180px);
        }
        @media (max-width: 768px) {
            body.book-opened .book-wrapper {
                transform: translateX(0); /* æ‰‹æœºä¸Šä¸å¹³ç§»ï¼Œç›´æ¥çœ‹å†…é¡µ */
            }
            body.book-opened .cover {
                /* æ‰‹æœºä¸Šå°é¢å½»åº•æ¶ˆå¤±ï¼Œé¿å…é®æŒ¡ */
                opacity: 0;Â 
                pointer-events: none;
            }
        }

        /* --- 5. å†…é¡µå¸ƒå±€ (Header & Content) --- */
        .page-header {
            padding: 20px 25px;
            border-bottom: 2px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fff;
        }
       Â 
        .date-display {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--text-main);
            line-height: 1;
        }
        .date-display span {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-sub);
            display: block;
            margin-top: 4px;
        }

        .weather-widget {
            text-align: right;
            font-size: 0.8rem;
            color: var(--text-sub);
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }
        .weather-icon { font-size: 1.2rem; margin-bottom: 2px; }

        .page-content {
            flex: 1;
            overflow-y: auto; /* å†…å®¹æ»šåŠ¨ */
            padding: 0;
            position: relative;
            background-image: radial-gradient(#e0e0e0 1px, transparent 1px); /* ç‚¹é˜µçº¸ */
            background-size: 20px 20px;
        }

        /* æ»šåŠ¨æ¡éšè— */
        .page-content::-webkit-scrollbar { width: 4px; }
        .page-content::-webkit-scrollbar-thumb { background: #ddd; border-radius: 2px; }

        /* --- 6. å¯†ç å±‚ --- */
        #auth-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95);
            backdrop-filter: blur(5px);
            z-index: 50;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 0.3s;
        }
        .hidden-layer {
            opacity: 0;
            pointer-events: none;
        }

        .auth-input {
            background: transparent;
            border: none;
            border-bottom: 2px solid #000;
            text-align: center;
            font-size: 1.5rem;
            width: 150px;
            padding: 5px;
            outline: none;
            font-weight: 700;
            letter-spacing: 2px;
        }
        .auth-btn {
            margin-top: 20px;
            background: #000;
            color: #fff;
            border: none;
            padding: 8px 24px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            cursor: pointer;
        }

        /* --- 7. ä¾§è¾¹æ ‡ç­¾ (Tabs) --- */
        .tabs-container {
            position: absolute;
            right: 0;
            top: 80px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 40;
        }
        .nav-tab {
            background: #333;
            color: #fff;
            padding: 8px 12px 8px 16px;
            border-radius: 4px 0 0 4px;
            font-size: 0.8rem;
            font-weight: 700;
            cursor: pointer;
            box-shadow: -2px 2px 5px rgba(0,0,0,0.1);
            transition: transform 0.2s;
            transform: translateX(5px); /* é»˜è®¤æ”¶èµ·ä¸€ç‚¹ */
        }
        .nav-tab.active {
            background: var(--primary-blue);
            transform: translateX(-2px);
        }
        .nav-tab:hover { transform: translateX(-5px); }

        /* --- 8. å†…å®¹åˆ—è¡¨ & å†™ä½œåŒº --- */
        .section { padding: 20px 25px; display: none; }
        .section.active { display: block; animation: slideUp 0.4s ease; }
       Â 
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* æ—¥è®°å¡ç‰‡ */
        .diary-item {
            background: #fff;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.03);
            cursor: pointer;
            transition: all 0.2s;
        }
        .diary-item:hover { transform: translateY(-2px); border-color: var(--primary-blue); }
        .item-date { font-size: 0.75rem; color: #999; font-weight: 600; margin-bottom: 5px; display: block; }
        .item-preview { font-size: 0.95rem; color: #333; line-height: 1.5; }
       Â 
        /* ç¼–è¾‘å™¨è°ƒæ•´ */
        #editor-container { height: 350px; border: none !important; font-size: 1rem; background: transparent; }
        .ql-toolbar { border: none !important; border-bottom: 1px solid #eee !important; padding: 8px !important; }
        .ql-container { border: none !important; }
       Â 
        /* æäº¤æŒ‰é’® */
        .submit-fab {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: var(--primary-blue);
            color: white;
            width: 50px; height: 50px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 12px rgba(0,71,171,0.3);
            cursor: pointer;
            transition: transform 0.2s;
            border: none;
            font-size: 1.5rem;
        }
        .submit-fab:hover { transform: scale(1.1) rotate(90deg); }

        /* è¯¦æƒ…é¡µ */
        .detail-view { display: none; padding: 20px 25px; }
        .detail-view.active { display: block; }
        .detail-body { margin-top: 20px; line-height: 1.8; color: #333; }
        .back-btn { font-size: 0.8rem; color: #999; cursor: pointer; margin-bottom: 10px; display: inline-block; }

        /* AI ç‚¹è¯„ (æç®€ç‰ˆ) */
        .teacher-note {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-left: 3px solid var(--primary-blue);
            font-size: 0.9rem;
            color: #555;
        }

    </style>
</head>
<body>

    <div class="book-wrapper" id="book">
       Â 
        <!-- å°é¢ -->
        <div class="cover" onclick="flipOpen()">
            <div>
                <div class="cover-title">MY<br>DIARY</div>
                <div class="cover-subtitle">DAILY LOG & STUDY</div>
            </div>
            <div class="cover-footer">
                <span>NO. 01</span>
                <span>JAPANESE LEARNING</span>
            </div>
            <!-- ä¼ªå…ƒç´ æ¨¡æ‹Ÿå°é¢èƒŒé¢ -->
            <div class="cover-back"></div>Â 
        </div>

        <!-- å†…é¡µ -->
        <div class="page">
           Â 
            <!-- é¡µé¢å¤´éƒ¨: æ—¥æœŸ + å¤©æ°” -->
            <div class="page-header">
                <div class="date-display" id="current-date">
                    16
                    <span>NOV. 2025</span>
                </div>
                <div class="weather-widget" id="weather-box">
                    <span class="weather-icon">â˜ï¸</span>
                    <span id="weather-temp">Loading...</span>
                    <span id="weather-loc" style="font-size: 0.7rem; opacity: 0.5;">Tokyo</span>
                </div>
            </div>

            <!-- ä¾§è¾¹å¯¼èˆª (ä¾¿åˆ©è´´) -->
            <div class="tabs-container" id="nav-tabs">
                <div class="nav-tab active" onclick="switchTab('list')">LIST</div>
                <div class="nav-tab" onclick="switchTab('write')">ADD</div>
            </div>

            <!-- å¯†ç å±‚ -->
            <div id="auth-layer">
                <div style="text-align: center;">
                    <p style="font-size: 0.8rem; color: #999; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px;">Security Check</p>
                    <input type="password" id="auth-input" class="auth-input" placeholder="CODE">
                    <br>
                    <button class="auth-btn" onclick="checkPass()">ENTER</button>
                    <p id="auth-msg" style="margin-top: 10px; color: red; font-size: 0.8rem;"></p>
                </div>
            </div>

            <!-- é¡µé¢å†…å®¹å®¹å™¨ -->
            <div class="page-content">
               Â 
                <!-- 1. åˆ—è¡¨è§†å›¾ -->
                <div id="view-list" class="section active">
                    <div id="diary-container">
                        <!-- JS å¡«å……æ—¥è®° -->
                    </div>
                    <div id="loader" style="text-align: center; padding: 20px; color: #999;">Loading...</div>
                </div>

                <!-- 2. å†™ä½œè§†å›¾ -->
                <div id="view-write" class="section">
                    <div id="editor-container"></div>
                    <button class="submit-fab" onclick="submitDiary()">+</button>
                </div>

                <!-- 3. è¯¦æƒ…è§†å›¾ -->
                <div id="view-detail" class="detail-view">
                    <span class="back-btn" onclick="switchTab('list')">â† BACK</span>
                    <h2 id="detail-title" style="font-size: 1.2rem; font-weight: 700; margin-bottom: 5px;"></h2>
                    <div id="detail-body" class="detail-body prose"></div>
                    <div id="detail-comment"></div>
                </div>

            </div>
        </div>
    </div>

    <script>
        let quill;
        let allSummaries = [];

        // --- 1. åˆå§‹åŒ– ---
        document.addEventListener('DOMContentLoaded', () => {
            // æ›´æ–°æ—¶é—´
            updateTime();
            setInterval(updateTime, 60000);
           Â 
            // è·å–å¤©æ°”
            getWeather();

            // åˆå§‹åŒ–ç¼–è¾‘å™¨
            quill = new Quill('#editor-container', {
                theme: 'snow',
                placeholder: 'Write something...',
                modules: {
                    toolbar: [['bold', 'italic', 'underline'], [{ 'list': 'ordered'}, { 'list': 'bullet' }]]
                }
            });

            // æ£€æŸ¥ç™»å½•çŠ¶æ€ (å¦‚æœå·²ç™»å½•ï¼Œç¿»å¼€ä¹¦åç›´æ¥éšè—å¯†ç å±‚)
            if (sessionStorage.getItem('diaryPassword')) {
                document.getElementById('auth-layer').style.display = 'none';
                loadData();
            }
        });

        // --- 2. ç¿»ä¹¦åŠ¨ç”» ---
        function flipOpen() {
            document.body.classList.add('book-opened');
        }

        // --- 3. å¯†ç éªŒè¯ ---
        function checkPass() {
            const input = document.getElementById('auth-input');
            const msg = document.getElementById('auth-msg');
            if (!input.value) return;
           Â 
            // ç®€å•å‰ç«¯æš‚å­˜ï¼ŒçœŸå®éªŒè¯åœ¨åç«¯
            sessionStorage.setItem('diaryPassword', input.value);
           Â 
            // æ·¡å‡ºå¯†ç å±‚
            const layer = document.getElementById('auth-layer');
            layer.style.opacity = '0';
            setTimeout(() => {
                layer.style.display = 'none';
                loadData(); // å°è¯•åŠ è½½æ•°æ®
            }, 300);
        }

        // --- 4. å¯¼èˆªåˆ‡æ¢ ---
        function switchTab(tab) {
            // éšè—æ‰€æœ‰
            document.getElementById('view-list').classList.remove('active');
            document.getElementById('view-write').classList.remove('active');
            document.getElementById('view-detail').classList.remove('active');
           Â 
            document.querySelectorAll('.nav-tab').forEach(el => el.classList.remove('active'));

            if (tab === 'list') {
                document.getElementById('view-list').classList.add('active');
                document.querySelectorAll('.nav-tab')[0].classList.add('active');
                loadData();
            } else if (tab === 'write') {
                document.getElementById('view-write').classList.add('active');
                document.querySelectorAll('.nav-tab')[1].classList.add('active');
            }
        }

        // --- 5. æ•°æ®äº¤äº’ ---
        async function loadData() {
            const container = document.getElementById('diary-container');
            const loader = document.getElementById('loader');
            const password = sessionStorage.getItem('diaryPassword');

            if (!password) return;

            // æ¨¡æ‹Ÿæœ¬åœ°é¢„è§ˆ
            if (location.protocol === 'file:' || location.hostname === 'localhost') {
                // ... æœ¬åœ°æµ‹è¯•ä»£ç  ...
            }

            try {
                const res = await fetch('/.netlify/functions/getSummaries');
                if (!res.ok) throw new Error('Auth failed');
                allSummaries = await res.json();
               Â 
                renderList(allSummaries);
                loader.style.display = 'none';
            } catch (e) {
                loader.innerText = "åŠ è½½å¤±è´¥æˆ–å¯†ç é”™è¯¯";
                console.error(e);
            }
        }

        function renderList(data) {
            const container = document.getElementById('diary-container');
            container.innerHTML = '';
           Â 
            // æŒ‰æ—¥æœŸå€’åº
            data.sort((a, b) => new Date(b.date) - new Date(a.date));

            data.forEach(item => {
                const div = document.createElement('div');
                div.className = 'diary-item';
               Â 
                const date = new Date(item.date);
                const dateStr = `${date.getMonth()+1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2,'0')}`;
               Â 
                // æå–çº¯æ–‡æœ¬é¢„è§ˆ
                const rawText = item.summary.replace(/<[^>]*>/g, '');
                const preview = rawText.substring(0, 60) + (rawText.length > 60 ? '...' : '');

                div.innerHTML = `
                    <span class="item-date">${dateStr}</span>
                    <div class="item-preview">${preview || '(Image/Empty)'}</div>
                `;
                div.onclick = () => showDetail(item);
                container.appendChild(div);
            });
        }

        function showDetail(item) {
            document.getElementById('view-list').classList.remove('active');
            document.getElementById('view-detail').classList.add('active');
           Â 
            const date = new Date(item.date);
            document.getElementById('detail-title').innerText = `${date.getFullYear()}.${date.getMonth()+1}.${date.getDate()}`;
            document.getElementById('detail-body').innerHTML = item.summary;
           Â 
            const commentBox = document.getElementById('detail-comment');
            if (item.gemini_response) {
                commentBox.innerHTML = `<div class="teacher-note"><strong>AI Note:</strong><br>${item.gemini_response}</div>`;
            } else {
                commentBox.innerHTML = '';
            }
        }

        async function submitDiary() {
            const password = sessionStorage.getItem('diaryPassword');
            const content = quill.root.innerHTML;
            const btn = document.querySelector('.submit-fab');
           Â 
            if (quill.getText().trim().length < 1) return alert("Empty content!");

            btn.disabled = true;
            btn.innerText = "...";

            try {
                const res = await fetch('/.netlify/functions/submitSummary', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password, summary: content })
                });
                if (!res.ok) throw new Error('Submit failed');
               Â 
                quill.setContents([]);
                switchTab('list');
            } catch (e) {
                alert("Error: " + e.message);
            } finally {
                btn.disabled = false;
                btn.innerText = "+";
            }
        }

        // --- 6. å·¥å…·å‡½æ•°: æ—¶é—´ä¸å¤©æ°” ---
        function updateTime() {
            const now = new Date();
            const monthNames = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
            const html = `
                ${now.getDate()}
                <span>${monthNames[now.getMonth()]}. ${now.getFullYear()}</span>
            `;
            document.getElementById('current-date').innerHTML = html;
        }

        async function getWeather() {
            // ä½¿ç”¨ Open-Meteo (å…è´¹, æ— éœ€ Key)
            // é»˜è®¤å®šä½åˆ°ä¸œäº¬ (å¯ä»¥æ”¹æˆæµè§ˆå™¨å®šä½)
            // æ—¢ç„¶æ˜¯æ—¥è¯­å­¦ä¹ , é»˜è®¤ä¸œäº¬å¾ˆåˆç†, æˆ–è€…ç”¨æµè§ˆå™¨å®šä½
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(async (pos) => {
                    fetchWeather(pos.coords.latitude, pos.coords.longitude);
                }, () => {
                    fetchWeather(35.6895, 139.6917); // é»˜è®¤ä¸œäº¬
                });
            } else {
                fetchWeather(35.6895, 139.6917);
            }
        }

        async function fetchWeather(lat, lon) {
            try {
                const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true`);
                const data = await res.json();
                const temp = Math.round(data.current_weather.temperature);
                const code = data.current_weather.weathercode;
               Â 
                // ç®€å•å¤©æ°”ä»£ç æ˜ å°„
                let icon = "â˜ï¸";
                if (code <= 1) icon = "â˜€ï¸";
                else if (code <= 3) icon = "â›…";
                else if (code <= 67) icon = "tğŸŒ§ï¸";
                else if (code <= 99) icon = "â›ˆï¸";

                document.getElementById('weather-temp').innerText = `${temp}Â°C`;
                document.querySelector('.weather-icon').innerText = icon;
            } catch (e) {
                console.log("Weather error");
            }
        }
    </script>
</body>
</html>
