<!DOCTYPE html>
<html lang="zh-CN"> <!-- ç§»é™¤äº† dark ç±» -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥è¯­å­¦ä¹ æ—¥è®° | æ¯æ—¥è®°å½•</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Quill.js (ä¿ç•™) -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

    <style>
        /* å¯¼å…¥å­—ä½“ (ä¿ç•™) */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap');
        
        /* 1. æ–°çš„ UI é£æ ¼: æ˜äº®ã€ç®€çº¦ */
        body { 
            font-family: 'Inter', 'Noto Sans JP', sans-serif; 
            /* æ–°çš„çº¸å¼ èƒŒæ™¯è‰² */
            background-color: #F7FAFC; 
            /* æ–°çš„é»˜è®¤æ–‡å­—é¢œè‰² */
            color: #2D3748; 
        }

        /* 2. æ–°çš„èƒŒæ™¯å¹»ç¯ç‰‡ (Bug ä¿®å¤) */
        #bg-slider {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -2;
            overflow: hidden;
            background-color: #F7FAFC; /* ç¡®ä¿èƒŒæ™¯ä¸æ˜¯é»‘è‰² */
        }
        .bg-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center center;
            /* å…³é”®ï¼šå¹³æ»‘çš„æ·¡å…¥æ·¡å‡ºè¿‡æ¸¡ (2ç§’) */
            transition: opacity 2s ease-in-out; 
            opacity: 0;
        }
        .bg-image.active {
            opacity: 1;
        }
        /* è’™ç‰ˆï¼šç°åœ¨æ˜¯ä¸€ä¸ªéå¸¸æ·¡çš„ç™½è‰²è’™ç‰ˆï¼Œè®©å›¾ç‰‡æ›´æŸ”å’Œ */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            /* ä»æ·±ç´«è‰²æ”¹ä¸ºæµ…ç™½è‰²æ¸å˜ */
            background: linear-gradient(rgba(247, 250, 252, 0.5), rgba(247, 250, 252, 0.85));
            z-index: -1;
        }

        /* 3. æ–°çš„å¡ç‰‡é£æ ¼: çº¸å¼  + é˜´å½± */
        .content-card { 
            /* ç§»é™¤ç»ç’ƒç‰¹æ•ˆ */
            background: #FFFFFF;
            border: 1px solid #E2E8F0;
            /* æ·»åŠ æŸ”å’Œã€è‡ªç„¶çš„é˜´å½± */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            transition: all 0.3s;
        }
        .content-card:hover { 
            transform: translateY(-6px); 
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.08); 
        }
        .summary-card { cursor: pointer; }

        /* 4. æ–°çš„ UI å…ƒç´ é¢œè‰² */
        /* æ ‡é¢˜: ç§»é™¤æ¸å˜, æ”¹ä¸ºçº¯é»‘ */
        .header-title {
            color: #1A202C;
            font-weight: 700;
        }
        .header-subtitle {
            color: #4A5568;
        }
        /* æ ‡ç­¾é¡µ: ç§»é™¤ç´«è‰², æ”¹ä¸ºçŸ³æ¿è“ */
        .tab-button.active { 
            color: white; 
            background-color: #4A5568; /* æ–°çš„å¼ºè°ƒè‰² */
        }
        .tab-button {
            color: #718096; /* é»˜è®¤æ–‡å­—é¢œè‰² */
        }
        /* è¡¨å•: æµ…è‰²ä¸»é¢˜ */
        .form-input { 
            background: #F7FAFC; /* æµ…è‰²èƒŒæ™¯ */
            border: 1px solid #CBD5E0; /* æµ…è‰²è¾¹æ¡† */
            color: #2D3748; /* æ·±è‰²æ–‡å­— */
        }
        .form-input:focus { 
            background: #FFFFFF; 
            border-color: #4A5568; /* æ–°çš„å¼ºè°ƒè‰² */
            box-shadow: 0 0 0 2px rgba(74, 85, 104, 0.3); 
        }
        /* æŒ‰é’®: ç§»é™¤æ¸å˜, æ”¹ä¸ºçŸ³æ¿è“ */
        .btn-primary { 
            background-color: #4A5568; /* æ–°çš„å¼ºè°ƒè‰² */
            color: white;
            transition: 0.3s; 
        }
        .btn-primary:hover { 
            background-color: #2D3748; /* å˜æ·± */
        }
        .btn-primary:disabled { 
            opacity: 0.5; 
            cursor: not-allowed; 
        }
        /* åŠ¨ç”» (ä¿ç•™) */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .summary-card, #section-detail { animation: fadeIn 0.5s ease-out forwards; }
        .loader { 
            border: 3px solid #E2E8F0; /* æµ…ç°è‰² */
            border-bottom-color: #4A5568; /* å¼ºè°ƒè‰² */
        }
        /* ç™»å½•æ¡†: æµ…è‰²ä¸»é¢˜ */
        #login-modal { 
            background: rgba(247, 250, 252, 0.9); /* æµ…è‰²èƒŒæ™¯ */
            backdrop-filter: blur(10px); 
        }
        
        /* 5. Quill ç¼–è¾‘å™¨: æ¢å¤é»˜è®¤ (äº®è‰²) */
        /* (ç§»é™¤æ‰€æœ‰è‡ªå®šä¹‰çš„ .ql- æš—è‰²ä¸»é¢˜æ ·å¼) */
        #editor-container { height: 250px; color: #2D3748; }
        .ql-container {
            font-size: 1rem;
        }

        /* 6. å†…å®¹æ¸²æŸ“: æµ…è‰²ä¸»é¢˜ */
        .summary-content p { margin-bottom: 0.5rem; color: #4A5568; }
        .summary-content strong { color: #1A202C; font-weight: 600; }
        .summary-content em { color: #C05621; /* æš–è‰²è°ƒ (èµ¤è¤è‰²) */ }
        .summary-content ul, .summary-content ol { margin-left: 1.5rem; margin-top: 0.5rem; margin-bottom: 0.5rem; color: #4A5568; }
        .summary-content li { margin-bottom: 0.25rem; }

        /* 7. Gemini ç‚¹è¯„: æµ…è‰²ä¸»é¢˜ */
        .gemini-response {
            margin-top: 1rem;
            font-size: 0.875rem;
            /* æµ…è“è‰²èƒŒæ™¯ + è“è‰²è¾¹æ¡† */
            background-color: #EBF8FF; 
            border-left: 3px solid #4299E1;
            padding: 0.75rem;
            color: #2C5282; /* æ·±è“è‰²æ–‡å­— */
        }
    </style>
</head>
<body class="text-gray-800 min-h-screen p-4 md:p-8">

    <!-- 2. æ–°çš„èƒŒæ™¯å¹»ç¯ç‰‡ HTML (Bug ä¿®å¤) -->
    <div id="bg-slider">
        <!-- 4 å¼ æ–°çš„ã€æ˜äº®çš„å›¾ç‰‡ -->
        <div class="bg-image" style="background-image: url('https://images.pexels.com/photos/208537/pexels-photo-208537.jpeg');"></div> <!-- ç«¹æ— -->
        <div class="bg-image" style="background-image: url('https://images.pexels.com/photos/161251/senso-ji-temple-japan-kyoto-161251.jpeg');"></div> <!-- æµ…è‰å¯º -->
        <div class="bg-image" style="background-image: url('https://images.pexels.com/photos/1371306/pexels-photo-1371306.jpeg');"></div> <!-- ç¦…é™¢ -->
        <div class="bg-image" style="background-image: url('https://images.pexels.com/photos/1034940/pexels-photo-1034940.jpeg');"></div> <!-- èŒ¶é“ -->
    </div>

    <!-- ç™»å½•é®ç½©å±‚ (å˜ä¸ºæµ…è‰²ä¸»é¢˜) -->
    <div id="login-modal">
        <div class="content-card rounded-xl p-8 shadow-lg max-w-sm w-full mx-4">
            <form id="login-form">
                <h2 class="text-2xl font-semibold text-center mb-6 text-gray-900">ğŸ”‘ è¯·è¾“å…¥å¯†ç </h2>
                <div class="mb-5">
                    <label for="login-password" class="block text-sm font-medium text-gray-700 mb-2">ç®¡ç†å‘˜å¯†ç </label>
                    <input type="password" id="login-password" class="form-input w-full rounded-lg p-3" placeholder="è¯·è¾“å…¥æ‚¨çš„å®‰å…¨å¯†ç " required>
                </div>
                <!-- æŒ‰é’®æ ·å¼æ›´æ–° -->
                <button type="submit" class="btn-primary w-full text-white font-bold py-3 px-6 rounded-lg text-lg">
                    <span>è¿›å…¥ç½‘ç«™</span>
                </button>
                <p id="login-message" class="mt-4 text-center text-red-600"></p>
            </form>
        </div>
    </div>

    <!-- é¡µé¢æ ‡é¢˜ (æ ·å¼æ›´æ–°) -->
    <header class="text-center mb-10">
        <h1 class="header-title text-4xl md:text-5xl font-bold">
            ğŸŒ¸ æˆ‘çš„æ—¥è¯­å­¦ä¹ æ—¥è®° ğŸŒ¸
        </h1>
        <p class="header-subtitle text-lg mt-2">æ—¥ã€…ã®è¨˜éŒ²ã€æœªæ¥ã¸ã®æŠ•è³‡ã€‚</p>
    </header>

    <!-- ä¸»åŒºåŸŸ (ä¸å˜) -->
    <main class="max-w-4xl mx-auto hidden" id="main-content">
        <!-- æ ‡ç­¾é¡µåˆ‡æ¢ (æ ·å¼æ›´æ–°) -->
        <div class="flex justify-center mb-8 bg-white/50 border border-gray-200/50 rounded-lg p-1 max-w-sm mx-auto">
            <button id="tab-view" class="tab-button active w-1/2 py-2 px-4 rounded-md font-medium transition-all duration-300">æŸ¥çœ‹æ€»ç»“</button>
            <button id="tab-submit" class="tab-button w-1/2 py-2 px-4 rounded-md font-medium transition-all duration-300">æäº¤æ–°æ€»ç»“</button>
        </div>

        <!-- å†…å®¹åŒºåŸŸ -->
        <div>
            <!-- æŸ¥çœ‹æ€»ç»“ (ä¸å˜) -->
            <section id="section-view">
                <div id="loading-spinner" class="text-center py-10">
                    <div class="loader mx-auto"></div>
                    <p class="mt-4 text-gray-500">æ­£åœ¨åŠ è½½æ—¥è®°...</p>
                </div>
                <!-- å¡ç‰‡æ ·å¼æ›´æ–° -->
                <div id="summary-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- æ€»ç»“å¡ç‰‡å°†åœ¨è¿™é‡ŒåŠ¨æ€æ’å…¥ -->
                </div>
                <p id="no-summaries" class="hidden text-center text-gray-500 py-10">è¿˜æ²¡æœ‰æ—¥è®°å“¦ï¼Œå¿«å»â€œæäº¤æ–°æ€»ç»“â€å§ï¼</p>
            </section>

            <!-- æäº¤æ€»ç»“ (æ ·å¼æ›´æ–°) -->
            <section id="section-submit" class="hidden">
                <div class="content-card rounded-xl p-6 md:p-10 shadow-lg max-w-lg mx-auto">
                    <form id="summary-form">
                        <h2 class="text-2xl font-semibold text-center mb-6 text-gray-900">ğŸ“ è®°å½•ä»Šæ—¥æ‰€å­¦</h2>
                        <input type="password" id="admin-password" class="hidden" required>
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">ğŸ“– å­¦ä¹ å†…å®¹</label>
                            <!-- Quill ç¼–è¾‘å™¨ (å°†ä½¿ç”¨é»˜è®¤äº®è‰²ä¸»é¢˜) -->
                            <div id="editor-container"></div>
                        </div>
                        <!-- æŒ‰é’®æ ·å¼æ›´æ–° -->
                        <button type="submit" id="submit-button" class="btn-primary w-full text-white font-bold py-3 px-6 rounded-lg text-lg mt-6">
                            <span>æäº¤æ€»ç»“</span>
                        </button>
                        <div id="form-message" class="mt-4 text-center"></div>
                    </form>
                </div>
            </section>
        </div>
    </main>

    <!-- è¯¦æƒ…åŒºåŸŸ (æ ·å¼æ›´æ–°) -->
    <section id="section-detail" class="hidden max-w-3xl mx-auto">
        <div class="content-card rounded-xl shadow-lg p-6 md:p-10">
            <!-- è¿”å›æŒ‰é’® -->
            <button id="back-to-list-button" class="inline-flex items-center text-gray-600 hover:text-gray-900 mb-6 transition-all">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
                è¿”å›åˆ—è¡¨
            </button>
            
            <!-- è¯¦æƒ…å†…å®¹ (æ ·å¼æ›´æ–°) -->
            <p id="detail-date" class="text-sm text-gray-500 mb-4"></p>
            <div id="detail-content" class="summary-content space-y-4">
                <!-- å®Œæ•´çš„æ—¥è®°å†…å®¹ -->
            </div>
            <div id="detail-gemini" class="mt-6">
                <!-- AI ç‚¹è¯„ (å°†ä½¿ç”¨ .gemini-response æ ·å¼) -->
            </div>
        </div>
    </section>

    <!-- é¡µè„š (ä¸å˜) -->
    <footer class="text-center text-gray-500 mt-16 pb-8">
        <p>&copy; 2025 ç”± Gemini å¼ºåŠ›é©±åŠ¨</p>
    </footer>

    <!-- æ ¸å¿ƒ JavaScript é€»è¾‘ (é‡å¤§æ›´æ–°) -->
    <script>
        // 1. æ—¥ç³»é£æ ¼èƒŒæ™¯å›¾ç‰‡ (æ–°çš„æ˜äº®å›¾ç‰‡)
        const japaneseImages = [
            'https://images.pexels.com/photos/208537/pexels-photo-208537.jpeg', // ç«¹æ—
            'https://images.pexels.com/photos/161251/senso-ji-temple-japan-kyoto-161251.jpeg', // æµ…è‰å¯º
            'https://images.pexels.com/photos/1371306/pexels-photo-1371306.jpeg', // ç¦…é™¢
            'https://images.pexels.com/photos/1034940/pexels-photo-1034940.jpeg'  // èŒ¶é“
        ];
        
        let allSummaries = [];
        let quill;

        document.addEventListener('DOMContentLoaded', () => {
            
            // --- å…ƒç´ è·å– (ä¸å˜) ---
            const loginModal = document.getElementById('login-modal');
            const loginForm = document.getElementById('login-form');
            const loginPasswordInput = document.getElementById('login-password');
            const loginMessage = document.getElementById('login-message');
            const mainContent = document.getElementById('main-content');
            
            const tabView = document.getElementById('tab-view');
            const tabSubmit = document.getElementById('tab-submit');
            const sectionView = document.getElementById('section-view');
            const sectionSubmit = document.getElementById('section-submit');
            
            const summaryForm = document.getElementById('summary-form');
            const submitButton = document.getElementById('submit-button');
            const formMessage = document.getElementById('form-message');
            const adminPasswordInput = document.getElementById('admin-password'); 
            
            const summaryGrid = document.getElementById('summary-grid');
            const loadingSpinner = document.getElementById('loading-spinner');
            const noSummaries = document.getElementById('no-summaries');

            const sectionDetail = document.getElementById('section-detail');
            const backToListButton = document.getElementById('back-to-list-button');
            const detailDate = document.getElementById('detail-date');
            const detailContent = document.getElementById('detail-content');
            const detailGemini = document.getElementById('detail-gemini');

            // 2. æ–°çš„å¹»ç¯ç‰‡å…ƒç´ 
            const bgSlider = document.getElementById('bg-slider');
            // (åŠ¨æ€åˆ›å»º, æˆ–ä» HTML ä¸­è·å–)
            // æˆ‘ä»¬åœ¨ HTML ä¸­åˆ›å»ºå®ƒä»¬, è¿™é‡Œå°±ä¸éœ€è¦äº†

            
            // --- åˆå§‹åŒ– Quill ç¼–è¾‘å™¨ (æ¢å¤é»˜è®¤äº®è‰²) ---
            quill = new Quill('#editor-container', {
                modules: {
                    toolbar: [
                        [{ 'header': [1, 2, 3, false] }],
                        ['bold', 'italic', 'underline'],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                        ['clean']
                    ]
                },
                theme: 'snow', // é»˜è®¤äº®è‰²ä¸»é¢˜
                placeholder: 'ä¾‹å¦‚ï¼šä»Šå¤©å­¦ä¹ äº†... æŒæ¡äº†... é‡åˆ°çš„é—®é¢˜æ˜¯...'
            });

            // --- ç™»å½•é€»è¾‘ (ä¸å˜) ---
            function checkLogin() { 
                const storedPassword = sessionStorage.getItem('diaryPassword');
                if (storedPassword) {
                    loginModal.style.display = 'none';
                    mainContent.classList.remove('hidden');
                    loadSummaries();
                } else {
                    loginModal.style.display = 'flex';
                    mainContent.classList.add('hidden');
                }
            }
            loginForm.addEventListener('submit', (e) => { 
                e.preventDefault();
                const inputPassword = loginPasswordInput.value;
                if (!inputPassword) {
                    loginMessage.textContent = 'è¯·è¾“å…¥å¯†ç ã€‚';
                    return;
                }
                sessionStorage.setItem('diaryPassword', inputPassword);
                loginModal.style.opacity = '0';
                setTimeout(() => { loginModal.style.display = 'none'; }, 300);
                mainContent.classList.remove('hidden');
                loadSummaries();
            });
            
            // --- å¯¼èˆª/æ ‡ç­¾é¡µåˆ‡æ¢é€»è¾‘ (ä¸å˜) ---
            function showViewSection() { 
                mainContent.classList.remove('hidden');
                sectionDetail.classList.add('hidden');
                sectionView.classList.remove('hidden');
                sectionSubmit.classList.add('hidden');
                tabView.classList.add('active'); // (ç®€åŒ–äº†ç±»)
                tabSubmit.classList.remove('active');
                loadSummaries();
            }
            function showSubmitSection() { 
                mainContent.classList.remove('hidden');
                sectionDetail.classList.add('hidden');
                sectionView.classList.add('hidden');
                sectionSubmit.classList.remove('hidden');
                tabView.classList.remove('active');
                tabSubmit.classList.add('active');
            }
            function showDetailView(itemDate) {
                const item = allSummaries.find(s => s.date === itemDate);
                if (!item) return;

                mainContent.classList.add('hidden');
                sectionDetail.classList.remove('hidden');
                
                const formattedDate = new Date(item.date).toLocaleString('zh-CN', { 
                    year: 'numeric', month: 'long', day: 'numeric',
                    hour: 'numeric', minute: 'numeric'
                });
                detailDate.textContent = formattedDate;
                detailContent.innerHTML = item.summary || '';
                
                if (item.gemini_response) {
                    // (ä½¿ç”¨æ–°çš„æ ·å¼)
                    detailGemini.innerHTML = `<div class="gemini-response">ğŸ¤– è€å¸ˆç‚¹è¯„ï¼š${item.gemini_response}</div>`;
                } else {
                    detailGemini.innerHTML = '';
                }
            }
            tabView.addEventListener('click', showViewSection);
            tabSubmit.addEventListener('click', showSubmitSection);
            backToListButton.addEventListener('click', showViewSection);


            // --- åŠ è½½æ€»ç»“é€»è¾‘ (ä¸å˜) ---
            async function loadSummaries() { 
                loadingSpinner.classList.remove('hidden');
                summaryGrid.innerHTML = ''; 
                noSummaries.classList.add('hidden');

                if (window.location.protocol.startsWith('blob') || window.location.protocol === 'file:') {
                    console.log("æœ¬åœ°é¢„è§ˆæ¨¡å¼ï¼šæ­£åœ¨åŠ è½½æ¨¡æ‹Ÿæ•°æ®...");
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    allSummaries = [
                        { date: new Date().toISOString(), summary: "<strong>ã€æ¨¡æ‹Ÿæ•°æ®ã€‘</strong><p>ä»Šå¤©å­¦ä¹ äº† N2 è¯­æ³•ã€Œï½ã‚‚ã®ã ã‹ã‚‰ã€ï¼Œæ„Ÿè§‰å¾ˆæœ‰è¶£ã€‚</p>", gemini_response: "ç´ æ™´ã‚‰ã—ã„ï¼ãã®èª¿å­ã§é ‘å¼µã£ã¦ï¼" },
                        { date: new Date(Date.now() - 86400000).toISOString(), summary: "<p>ã€æ¨¡æ‹Ÿæ•°æ®ã€‘å¤ä¹ äº† N3 çš„åŠ¨è¯å˜å½¢ã€‚</p>", gemini_response: "åŸºæœ¬ã¯å¤§äº‹ã§ã™ã­ã€‚ã‚ˆãã§ãã¾ã—ãŸï¼" }
                    ];
                    renderSummaries(allSummaries);
                    loadingSpinner.classList.add('hidden');
                    return; 
                }
                
                try {
                    const response = await fetch('/.netlify/functions/getSummaries');
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    allSummaries = await response.json();
                    renderSummaries(allSummaries); 
                } catch (error) {
                    console.error('åŠ è½½æ€»ç»“å¤±è´¥:', error);
                    noSummaries.textContent = 'âŒ åŠ è½½æ—¥è®°å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•ã€‚';
                    noSummaries.classList.remove('hidden');
                } finally {
                    loadingSpinner.classList.add('hidden');
                }
            }

            // --- æ¸²æŸ“æ€»ç»“å¡ç‰‡ (æ ·å¼æ›´æ–°) ---
            function renderSummaries(summaries) {
                summaryGrid.innerHTML = ''; 
                if (!summaries || summaries.length === 0) {
                    noSummaries.classList.remove('hidden');
                } else {
                    summaries.sort((a, b) => new Date(b.date) - new Date(a.date));
                    summaries.forEach(item => {
                        const card = document.createElement('div');
                        card.setAttribute('data-date-id', item.date);
                        // (ä½¿ç”¨æ–°çš„å¡ç‰‡æ ·å¼)
                        card.className = 'summary-card content-card rounded-xl shadow-lg flex flex-col p-6 transition-all duration-300';
                        
                        const formattedDate = new Date(item.date).toLocaleString('zh-CN', { 
                            year: 'numeric', month: 'long', day: 'numeric'
                        });
                        
                        // (ä½¿ç”¨æ–°çš„ç‚¹è¯„æ ·å¼)
                        const geminiTextHtml = item.gemini_response 
                            ? `<div class="gemini-response">ğŸ¤– è€å¸ˆç‚¹è¯„ï¼š${item.gemini_response}</div>` 
                            : '';
                        
                        const plainTextSummary = item.summary.replace(/<[^>]*>?/gm, ' ').replace(/\s+/g, ' ').trim();
                        const snippet = plainTextSummary.substring(0, 100) + (plainTextSummary.length > 100 ? '...' : '');

                        card.innerHTML = `
                            <p class="text-sm text-gray-500 mb-2">${formattedDate}</p>
                            <div class="text-gray-700 summary-content-snippet flex-grow">
                                <p>${snippet || '(ç©ºæ—¥è®°)'}</p>
                            </div>
                            ${geminiTextHtml}
                        `;
                        card.addEventListener('click', () => {
                            showDetailView(item.date);
                        });
                        summaryGrid.appendChild(card);
                    });
                }
            }

            // --- è¡¨å•æäº¤é€»è¾‘ (ä¸å˜) ---
            summaryForm.addEventListener('submit', async (e) => { 
                e.preventDefault(); 
                const storedPassword = sessionStorage.getItem('diaryPassword') || '';
                adminPasswordInput.value = storedPassword;
                const password = adminPasswordInput.value;
                const summaryHtml = quill.root.innerHTML;
                
                if (summaryHtml === '<p><br></p>' || summaryHtml.trim() === '') {
                    formMessage.textContent = 'âŒ å­¦ä¹ å†…å®¹ä¸èƒ½ä¸ºç©ºã€‚';
                    formMessage.className = 'mt-4 text-center text-red-600';
                    return;
                }
                
                submitButton.disabled = true;
                formMessage.textContent = '';
                formMessage.className = 'mt-4 text-center text-green-600'; // é»˜è®¤æˆåŠŸè‰²

                try {
                    submitButton.innerHTML = `<span>æäº¤æ€»ç»“...</span>`;

                    if (window.location.protocol.startsWith('blob') || window.location.protocol === 'file:') {
                        console.log("æœ¬åœ°é¢„è§ˆæ¨¡å¼ï¼šæ­£åœ¨æ¨¡æ‹Ÿæäº¤...", { password, summary: summaryHtml });
                        await new Promise(resolve => setTimeout(resolve, 1500)); 
                        if (password !== '123') { 
                            formMessage.textContent = 'âŒ ã€æ¨¡æ‹Ÿã€‘å¤±è´¥: å¯†ç æ— æ•ˆ';
                            formMessage.className = 'mt-4 text-center text-red-600';
                        } else {
                            formMessage.textContent = 'ğŸ‰ ã€æ¨¡æ‹Ÿã€‘æäº¤æˆåŠŸï¼';
                            quill.setContents([{ insert: '\n' }]);
                            setTimeout(() => { showViewSection(); formMessage.textContent = ''; }, 2000);
                        }
                        submitButton.disabled = false;
                        submitButton.innerHTML = '<span>æäº¤æ€»ç»“</span>';
                        return; 
                    }

                    const response = await fetch('/.netlify/functions/submitSummary', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ password, summary: summaryHtml })
                    });
                    const result = await response.json();
                    if (!response.ok) throw new Error(result.error || 'æäº¤å¤±è´¥');
                    
                    formMessage.textContent = 'ğŸ‰ æäº¤æˆåŠŸï¼å·²ç”Ÿæˆ AI ç‚¹è¯„ã€‚';
                    quill.setContents([{ insert: '\n' }]);
                    setTimeout(() => { showViewSection(); formMessage.textContent = ''; }, 2000);

                } catch (error) {
                    console.error('æäº¤å¤±è´¥:', error);
                    if (error.message.includes('å¯†ç æ— æ•ˆ')) {
                        loginMessage.textContent = 'å¯†ç é”™è¯¯ï¼è¯·åˆ·æ–°é¡µé¢é‡è¯•ã€‚';
                        loginModal.style.display = 'flex'; 
                        loginModal.style.opacity = '1';
                        sessionStorage.removeItem('diaryPassword');
                    } else {
                        formMessage.textContent = `âŒ å¤±è´¥: ${error.message}`;
                    }
                    formMessage.className = 'mt-4 text-center text-red-600';
                } finally {
                    submitButton.disabled = false;
                    submitButton.innerHTML = '<span>æäº¤æ€»ç»“</span>';
                }
            });

            // --- 3. æ–°çš„å¹»ç¯ç‰‡é€»è¾‘ (Bug ä¿®å¤) ---
            function initBackgroundSlider() {
                const bgImages = bgSlider.querySelectorAll('.bg-image');
                let currentImageIndex = 0;

                // è®¾ç½®åˆå§‹å›¾ç‰‡ (å›¾ç‰‡å·²åœ¨ HTML ä¸­ç”¨ style å®šä¹‰)
                if (bgImages.length > 0) {
                    bgImages[currentImageIndex].classList.add('active');
                }

                setInterval(() => {
                    // ç§»é™¤å½“å‰ active ç±»
                    bgImages[currentImageIndex].classList.remove('active');
                    
                    // è®¡ç®—ä¸‹ä¸€ä¸ª
                    currentImageIndex = (currentImageIndex + 1) % bgImages.length;
                    
                    // æ·»åŠ  active ç±»åˆ°ä¸‹ä¸€ä¸ª
                    bgImages[currentImageIndex].classList.add('active');

                }, 10000); // 10 ç§’åˆ‡æ¢ä¸€æ¬¡, 2ç§’æ·¡å…¥, 8ç§’æ˜¾ç¤º
            }

            // --- åˆå§‹åŠ è½½ ---
            checkLogin();
            initBackgroundSlider(); // å¯åŠ¨èƒŒæ™¯å¹»ç¯ç‰‡
            
        });
    </script>
</body>
</html>